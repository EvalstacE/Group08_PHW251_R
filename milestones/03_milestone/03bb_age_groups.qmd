# Age Categories

```{r}
#| include: false
#| warning: false
#| message: false

# Load and install packages
pacman::p_load(
  dplyr, tidyr, ggplot2, lubridate, ggthemes, cowplot, readr, rlang, purrr, rlang,
  classInt, tidycensus, sf, here, stringr, purrr, svglite, rmapshaper, readxl,
  scales, ggrepel, viridis, RColorBrewer, maps, ggfx, glue, skimr, DataExplorer,
  knitr, kableExtra, janitor, reactable, MMWRweek
)

# Source all helper functions
func_dir <- here::here("functions")
r_files <- list.files(func_dir, pattern = "\\.R$", full.names = TRUE)
purrr::walk(r_files, source)


# === Load all CSVs from _data/tbl_outputs_03 ===
data_dir <- here::here("data", "tbl_outputs_03")

csv_files <- list.files(
  path = data_dir,
  pattern = "\\.csv$",
  full.names = TRUE
)

# Read and assign each CSV to an object named after its file
purrr::walk(csv_files, function(file_path) {
  # Extract clean base name (no extension)
  obj_name <- tools::file_path_sans_ext(basename(file_path))
  # Read file
  df <- readr::read_csv(file_path, show_col_types = FALSE)
  # Assign to the global environment so all chapters can access
  assign(obj_name, df, envir = knitr::knit_global())
})

```


The population database contains counts for six age groups, whereas the California and LA County databases use four. Because the groupings align --- “0–4,” “5–11,” and “12–17” in the population database correspond to the “0–17” group in the others --- we summarized the population counts to match the four age-group format. 

In the original population database, counts are reported for each single year of age within every demographic subgroup (e.g., county, sex, race/ethnicity). To obtain total estimates per age group and demographic category, the single-year counts were aggregated (summed). 

**Table 1** below presents a subset of the original and restructured population data to illustrate the resulting summarized age groupings. 


```{r}

step2_pop_df <- step1_pop_df %>%
  group_by(
      county, health_officer_region, 
      sex, race_ethnicity, age_cat
  ) %>%
  summarise(pop = sum(pop), .groups = "drop")

#-aggregate population counts 
##--to 4 age category format:
step2_pop_df_recat <- step1_pop_df %>%
  mutate(
    new_age_group = 
      if_else(
        age_cat %in% 
          c("0-4", "5-11", "12-17"),
              "0-17", age_cat)
  ) %>%
  group_by(
      county, health_officer_region, sex, 
      race_ethnicity, new_age_group
  ) %>%
  summarise(pop = sum(pop), .groups = "drop") %>%
  rename("age_cat" = "new_age_group")
  
```



```{r, echo = FALSE}

pop_df_subset <- step2_pop_df %>%
  select(-health_officer_region) %>%
  filter(
    county == "Alameda",
    age_cat %in% c("0-4", "5-11", "12-17"),
    race_ethnicity == "Hispanic",
    sex == "FEMALE"
  ) %>% janitor::adorn_totals() %>%
  mutate(
    across(where(is.numeric), 
        ~ ifelse(county == "Total", 
                 comma(., accuracy = 1), .))
    )


pop_recat_subset <- step2_pop_df_recat %>%
  select(-health_officer_region) %>%
  filter(
    county == "Alameda",
    age_cat == "0-17",
    race_ethnicity == "Hispanic",
    sex == "FEMALE"
  ) %>%
  mutate(pop = comma(pop, accuracy = 1))


```


::: {.column-box}

#### Table 1: Reconciling Age Group Categories and Population Counts

**Original Age Groups:**
```{r, echo = FALSE}
pop_df_subset %>% 
  kbl(align = "c",
      col.names = c("County", "Sex", "Race / Ethnicity", "Age Group", "Population")
      ) %>%
  row_spec(0, 
           bold = TRUE, 
           background = "#0f172a",
           extra_css = "font-size: 16px!important;color:#ffffff;") %>%
  row_spec(4, 
      bold = TRUE, 
      background = "#5ce1e6", 
      extra_css = "font-size: 16px!important;"
  ) %>%
  kable_styling(bootstrap_options = c("striped", "condensed", "bordered", "hover"))
```




**New, Aggregate Age Group:**
```{r, echo = FALSE}
pop_recat_subset %>% 
  kbl(align = "c",
      col.names = c("County", "Sex", "Race / Ethnicity", "Age Group", "Population"),
      table.attr = 'class="table table-bordered no-stripe"'
      ) %>%
  kable_styling(bootstrap_options = c("striped", "condensed", "bordered", "hover")) %>%
  row_spec(0, 
           bold = TRUE, 
           background = "#0f172a",
           extra_css = "font-size: 16px!important;color:#ffffff;") %>%
  row_spec(1, background = "#ffffff") %>%
  column_spec(5, 
      bold = TRUE, 
      background = "#5ce1e6", 
      extra_css = "font-size: 16px!important;"
  )
  
```


:::


