
# Race and Ethnicity: 

```{r}
#| label: setup
#| include: false
#| warning: false
#| message: false

# Load and install packages
pacman::p_load(
  dplyr, tidyr, ggplot2, lubridate, ggthemes, cowplot, readr, rlang, purrr, rlang,
  classInt, tidycensus, sf, here, stringr, purrr, svglite, rmapshaper, readxl,
  scales, ggrepel, viridis, RColorBrewer, maps, ggfx, glue, skimr, DataExplorer,
  knitr, kableExtra, janitor, reactable, MMWRweek
)

# Source all helper functions
func_dir <- here::here("functions")
r_files <- list.files(func_dir, pattern = "\\.R$", full.names = TRUE)
purrr::walk(r_files, source)


# === Load all CSVs from _data/tbl_outputs_03 ===
data_dir <- here::here("data", "tbl_outputs_03")

csv_files <- list.files(
  path = data_dir,
  pattern = "\\.csv$",
  full.names = TRUE
)

# Read and assign each CSV to an object named after its file
purrr::walk(csv_files, function(file_path) {
  # Extract clean base name (no extension)
  obj_name <- tools::file_path_sans_ext(basename(file_path))
  # Read file
  df <- readr::read_csv(file_path, show_col_types = FALSE)
  # Assign to the global environment so all chapters can access
  assign(obj_name, df, envir = knitr::knit_global())
})

```


Each of the three datasets defines Race / Ethnicity differently. The California dataset uses numeric codes, the Los Angeles County dataset uses full text labels, and the population dataset uses abbreviated text. 

To resolve this, we created a crosswalk file (**race_ethnicity_map.csv**) that aligns the three formats. By joining this crosswalk to each dataset, we ensure that all three contain a consistent set of race and ethnicity variables: each with the numeric code, the abbreviated text, and the full text label.


```{r, echo = FALSE}
race_ethnicity_map <- read.csv(file = here("data/race_ethnicity_map.csv")) %>%
  mutate(
    race_long = clean(race_long),
    race_short = clean(race_short),
    race_coded = as.character(race_coded)
  )

```


```{r}

step2_ca_df <- step2_ca_df %>%
  rename("race_coded" = "race_ethnicity") %>%
  mutate(race_coded = as.character(race_coded)) %>%
  left_join(race_ethnicity_map, by = "race_coded")%>%
  relocate(race_coded, race_short, race_long, .after = sex)

step2_la_cnty_df <- step2_la_cnty_df %>%
  mutate(race_long = clean(race_ethnicity)) %>%
  select(-race_ethnicity) %>%
  left_join(race_ethnicity_map, by = "race_long") %>%
  relocate(race_coded, race_short, race_long, .after = sex)


```



### Race and Ethnicity Crosswalk Table:

```{r, echo = FALSE}

race_ethnicity_map %>% 
  kbl(align = "c") %>%
  kable_styling(bootstrap_options = c("bordered")) %>%
  row_spec(0, 
           bold = TRUE, 
           background = "#0f172a",
           extra_css = 
           "font-size: 14px!important;color:#ffffff;") 
```



