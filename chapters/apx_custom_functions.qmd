# Custom Functions


::: {.callout-note icon=false collapse="true"}

## `clean()`

**Description:**  

Removes unwanted whitespace and formatting inconsistencies from character data.  
This utility function converts the input to a character vector, trims leading and trailing spaces, and collapses multiple internal spaces into a single space.


**Usage:**

```{r, eval = FALSE}
#| code-fold: show

df %>% clean(x)

```


**Details:**

The function is designed to standardize text fields before joining, grouping, or comparison operations.

It combines as.character(), stringr::str_trim(), and stringr::str_squish() for efficient whitespace cleanup.

**Returned Value:**

A character vector with trimmed and normalized spacing.

:::


::: {.callout-note icon=false collapse="true"}

## `add_mmwr_week_columns()`

**Description:**  

This function uses the `MMWRweek` package to convert calendar dates into the standardized **MMWR (Morbidity and Mortality Weekly Report)** week and year format commonly used in public health surveillance. Adds two new columns (`mmwr_year` and `mmwr_week`) to a dataset based on a specified date column.This function is particularly useful for aligning time series data to standardized epidemiological reporting periods.


**Usage:**

```{r, eval = FALSE}
#| code-fold: show

add_mmwr_week_columns(data, date_col = "date")

```


**Arguments:**

* `data` : A data frame containing a date field. 

* `date_col` : The column name containing the date (must be a recognizable Date class)


**Details:**
The function extracts the specified date column, converts each date to its corresponding MMWR week and year using MMWRweek::MMWRweek(), and appends these as two new factor columns: mmwr_year and mmwr_week. 


**Returned Columns:**

* **mmwr_year:** MMWR reporting year

* **mmwr_week:** MMWR reporting week number


:::



::: {.callout-note icon=false collapse="true"}

## `add_start_end_dates()`

**Description:**  

Adds the **start** and **end** dates corresponding to each MMWR week and year.  
This function uses the `MMWRweek::MMWRweek2Date()` function to convert MMWR week-year combinations into actual calendar dates, making it easier to interpret and visualize epidemiological data over time.


**Usage:**

```{r, eval = FALSE}
#| code-fold: show

add_start_end_dates(data, year_col = "mmwr_year", week_col = "mmwr_week")

```


**Arguments:**

* `data`: A data frame containing MMWR week and year columns
* `year_col`: The column name for MMWR year. Defaults to "mmwr_year"
* `week_col`: The column name for MMWR week. Defaults to "mmwr_week"


**Details:**

The function extracts MMWR year and week values from the specified columns and converts them to corresponding start (Monday) and end (Sunday) calendar dates using the MMWRweek2Date() function from the MMWRweek package.

This is useful for labeling plots, aligning data with other time series, or verifying that reporting periods match expected calendar intervals.


**Returned Columns:**

* **start_date:** Calendar date of the first day of the MMWR week (Monday)

* **end_date:** Calendar date of the last day of the MMWR week (Sunday)


:::




::: {.callout-note icon=false collapse="true"}

## `calc_total_rates_pop()` 

**Description:**

Calculates total infection counts and crude infection rates per 100,000 population for one or more grouping variables. This function is useful for standardizing rate calculations across demographic groups (e.g., by county, region, sex, or race/ethnicity). 

**Usage:**

```{r, eval = FALSE}
#| code-fold: show

calc_total_rates_pop(df, ..., pop_col)

```



**Arguments:**

* `df` : A data frame containing cumulative infection, severe, and unrecovered counts, grouping variables, and population counts per group. 

* `...` : Column names for one or more grouping variables (comma-separated) to summarize rates by (e.g., county, sex, race_ethnicity).

* `pop_col` : The column name containing population counts for the group(s) used to compute rates.

**Details:**

This function groups the input data by the specified variables and returns a summarized dataset with total counts, proportions, and rates (per 100,000 population) for infections, severe infections, and unrecovered cases.

**Returned Columns:**

* **total_pop:**  Total population for the group

* **total_infected:** Cumulative infection count

* **inf_rate_100k:** Infection rate per 100,000 population

* **total_severe:** Cumulative severe infections

* **sev_rate_100k:** Severe infection rate per 100,000 population

* **total_unrec:** Cumulative unrecovered cases

* **unrec_rate_100k:** Unrecovered rate per 100,000 population


:::


::: {.callout-note icon=false collapse="true"}

## `make_rate_table()`

**Description:**  

Builds a styled summary table for crude rates with optional row filtering and a highlighted rate column. The function selects grouping columns and rate columns, drops unwanted columns, sorts by a chosen metric, optionally keeps the top `n` rows, and returns a formatted `knitr_kable/kableExtra` table.


**Usage:**

```{r, eval = FALSE}
#| code-fold: show

make_rate_table(
  df,
  ...,
  pop_col = total_pop,
  rate_pattern = "_rate($|_)",
  drop_cols = "unrec_rate_100k",
  sort_by = "sev_rate_100k",
  top_n = NULL,
  highlight_col = "sev_rate_100k",
  highlight_bg = "#5ce1e6"
)

```



**Arguments:**

* `df`:	Data frame that contains grouping variables, a population column, and one or more rate columns

* `...`:	One or more grouping columns to display (for example county, health_officer_region)

* `pop_col`:	Unquoted population column to include in the table. Uses tidy-eval (e.g., total_pop)

* `rate_pattern`:	Regular expression used by dplyr::matches() to select rate columns. Default matches columns ending in _rate or _rate_

* `drop_cols`:	Character vector of column names to remove after selection

* `sort_by`:	Column name (character) used for descending sort. Must exist in df after selection

* `top_n`:	Integer. If supplied, keeps only the first n rows after sorting

* `highlight_col`:	Column name (character) to visually highlight with column_spec(). If not found, no highlight is applied

* `highlight_bg`:	Hex color for the highlighted column background


**Returned Object:**

A kableExtra table object for display in HTML documents.

:::
