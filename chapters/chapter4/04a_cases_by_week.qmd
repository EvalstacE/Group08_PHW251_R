# Course of the Outbreak

::: {.wide-embed}

::: {.panel-tabset}

## Map

#### Infection Rates by Week
* Adjust the slider to follow the progression of the outbreak week by week. Every point reflects the infection rate or severe infection rate for a California county, standardized per 100,000 population. 

* Counties that are shaded are those in the highest top five for either infection or severe infection rates. 



```{=html}

<iframe 
  src="https://evalue.shinyapps.io/Group08_County_Weekly_Map/"
  width="100%" 
  height="740px" 
  frameborder="0">
</iframe>

```

:::

:::


#### Supporting Code: 

The full code for the interactive maps can be found on the github repository within the "cases_week_app" branch:
**<https://github.com/EvalstacE/Group08_PHW251_R/tree/cases_week_app>**


[Download Shiny App Code (ZIP)](../../www/Group08_weekly_case_map_shiny_app.zip){.btn .btn-primary target="_blank"}



|
|



**Create weekly infection and severe case dataframe by county and health officer region:**

```{r, eval = FALSE}

## -- weekly case data by county
cnty_weekly_cases <- combined_df %>%
group_by(
    health_officer_region,
    county,
    mmwr_week,
    start_date,
    end_date
) %>%
summarise(
    cumulative_infected = sum(cumulative_infected, na.rm = TRUE),
    cumulative_severe = sum(cumulative_severe, na.rm = TRUE),
    total_cnty_pop = first(total_cnty_pop), 
    inf_rate_100k = round((10^4 * cumulative_infected / total_cnty_pop),1),
    sev_rate_100k = round((10^4 * cumulative_severe / total_cnty_pop),1),
    .groups = "drop"
) %>%

create_EQ_lbl(cumulative_infected, n = 5, new_col = "case_breaks", round_fn = floor) %>%
create_EQ_lbl(inf_rate_100k, n = 5, new_col = "inf_rate_breaks", round_fn = floor) %>%
create_EQ_lbl(cumulative_severe, n = 5, new_col = "sev_case_breaks", round_fn = floor) %>%
create_EQ_lbl(sev_rate_100k, n = 5, new_col = "sev_rate_breaks", round_fn = floor)


## -- weekly case data by HOR
hor_weekly_cases <- combined_df %>%
group_by(
    health_officer_region,
    mmwr_week,
    start_date,
    end_date
) %>%
summarise(
    cumulative_infected = sum(cumulative_infected, na.rm = TRUE),
    cumulative_severe = sum(cumulative_severe, na.rm = TRUE),
    total_HOR_pop = first(total_HOR_pop), 
    inf_rate_100k = round((10^4 * cumulative_infected / total_HOR_pop),1),
    sev_rate_100k = round((10^4 * cumulative_severe / total_HOR_pop),1),
    .groups = "drop"
) %>%

create_EQ_lbl(cumulative_infected, n = 5, new_col = "case_breaks", round_fn = floor) %>%
create_EQ_lbl(inf_rate_100k, n = 5, new_col = "inf_rate_breaks", round_fn = floor) %>%
create_EQ_lbl(cumulative_severe, n = 5, new_col = "sev_case_breaks", round_fn = floor) %>%
create_EQ_lbl(sev_rate_100k, n = 5, new_col = "sev_rate_breaks", round_fn = floor)


#- Export / save dfs:
#-- write.csv(cnty_weekly_cases, here("data/cleaned_data/cnty_weekly_cases.csv"), row.names = FALSE)
#-- write.csv(hor_weekly_cases, here("data/cleaned_data/hor_weekly_cases.csv"), row.names = FALSE)

```


**Creating and saving shapefiles for maps:**

```{r, eval = FALSE}

##--bring in California shapefile and 
###---join to infection rate dataframe
ca_cnty_sf <- counties(state = "CA", cb = TRUE, year = 2023) %>%
  st_as_sf() %>%
  select(NAME) %>%
  left_join(inf_rates_by_cnty, by = c("NAME" = "county")) %>%
  rename("county" = "NAME") %>%
  st_transform(4326)


##--dissolves counties into Health Officer Regions
hor_sf <- ca_cnty_sf %>%
  group_by(health_officer_region) %>%
  summarise(.groups = "drop")%>%
  st_cast("MULTIPOLYGON")%>%
  left_join(inf_rates_by_HOR, by = "health_officer_region") %>%
  st_transform(4326)

##--creates points centered in polygons
ca_cnty_pnts <- ca_cnty_sf %>%
  st_centroid() %>%              
  mutate(
    lng = st_coordinates(.)[, 1],
    lat = st_coordinates(.)[, 2]
  ) %>%
  st_drop_geometry() %>%
  select(county, lng, lat)


hor_pnts <- hor_sf %>%
  st_centroid() %>%              
  mutate(
    lng = st_coordinates(.)[, 1],
    lat = st_coordinates(.)[, 2]
  ) %>%
  st_drop_geometry() %>%
  select(health_officer_region, lng, lat)


## -- make weekly point data
cnty_week_pnts <- cnty_weekly_cases %>%
  left_join(ca_cnty_pnts, by = "county")

hor_week_pnts <- hor_weekly_cases %>%
  left_join(hor_pnts, by = "health_officer_region")


##--save to data/shapefiles folder
##-st_write(ca_cnty_sf, here("data/shapefiles/ca_cnty_sf/ca_cnty_sf.shp"), append = FALSE)
##-st_write(hor_sf, here("data/shapefiles/hor_sf/hor_sf.shp"), append = FALSE)
##-st_write(ca_cnty_pnts, here("data/shapefiles/ca_cnty_pnts/ca_cnty_pnts.shp"), append = FALSE)
##-st_write(hor_pnts, here("data/shapefiles/hor_pnts/hor_pnts.shp"), append = FALSE)
##-write.csv(cnty_week_pnts, here("data/shapefiles/cnty_week_pnts.csv"), row.names = FALSE)
##-write.csv(hor_week_pnts, here("data/shapefiles/hor_week_pnts.csv"), row.names = FALSE)

```


**Global variables and dataframes for the shiny app:**

```{r, eval = FALSE}

## - Bring in shapefiles
geoms <- bring_in_sfs()

ca_cnty_pnts <- geoms$ca_cnty_pnts
hor_sf   <- geoms$hor_sf
hor_pnts <- geoms$hor_pnts
cnty_week_pnts <- read.csv(file = here("data/shapefiles/cnty_week_pnts.csv"))
hor_week_pnts <- read.csv(file = here("data/shapefiles/hor_week_pnts.csv"))

ca_cnty_sf <- geoms$ca_cnty_sf %>%
  left_join(inf_rates_by_cnty, by = "county")

top_cnty_rates <- ca_cnty_sf %>%
  arrange(desc(inf_rate_100k)) %>%
  slice_head(n = 5) %>%
  bind_rows(
    ca_cnty_sf %>%
      arrange(desc(sev_rate_100k)) %>%
      slice_head(n = 5)
  ) %>%
  distinct()

break_cols <- c("case_breaks", "inf_rate_breaks",
                "sev_case_breaks", "sev_rate_breaks")

cnty_week_pnts <- cnty_week_pnts %>%
  mutate(across(all_of(break_cols), enforce_factor_levels))

hor_week_pnts <- hor_week_pnts %>%
  mutate(across(all_of(break_cols), enforce_factor_levels))

  

## - color palettes for maps

cnty_rate_levels <- levels(cnty_week_pnts$inf_rate_breaks)
cnty_sev_rate_levels <- levels(cnty_week_pnts$sev_rate_breaks)
cnty_case_levels <- levels(cnty_week_pnts$case_breaks)


custom_pal_cases <- colorFactor(
  palette = c(
    "#fdacb8",
    "#b93f76",
    "#892a68",
    "#52176b",
    "#1e0c47"
  ),
  domain  = cnty_rate_levels, 
  ordered = TRUE
)


custom_pal_sev_cases <- colorFactor(
  palette = c(
    "#fdacb8",
    "#b93f76",
    "#892a68",
    "#52176b",
    "#1e0c47"
  ),
  domain  = cnty_sev_rate_levels, 
  ordered = TRUE
)


## -- scale infections + severe infections proportionally 

sev_scale <- 
  max(cnty_week_pnts$inf_rate_100k, na.rm = TRUE) /
  max(cnty_week_pnts$sev_rate_100k, na.rm = TRUE)

```

