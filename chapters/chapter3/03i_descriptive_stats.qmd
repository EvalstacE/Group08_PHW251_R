# Infection Rates by Demographic


```{r}
#| include: false
#| warning: false
#| message: false

source("_common.R")

```


```{r}
#| code-fold: show

# Bring in final combined database
df <- combined_df

```




## Calculating Crude Rates

To simplify and standardize the process of calculating crude infection rates across multiple demographic groupings, we created a custom helper function: `calc_total_rates_pop()` 


**The main arguments are:**

* `df` : name of the combined dataframe object

* `...` : column name(s) of grouping variables (comma-separated if more than one)

* `pop_col` : column name of the population count that should be used to calculate rates


```{r, eval = FALSE}
#| code-fold: show


calc_total_rates_pop <- function(df, ..., pop_col) {
  df %>%
    group_by(...) %>%
    summarise(
      total_pop = first({{ pop_col }}),
      total_infected = max(cumulative_infected, na.rm = TRUE),
      total_inf_prop = total_infected / total_pop,
      inf_rate_100k = round(total_inf_prop * 1e5, 1),
      total_severe = max(cumulative_severe, na.rm = TRUE),
      total_sev_prop = total_severe / total_pop,
      sev_rate_100k = round(total_sev_prop * 1e5, 1),
      total_unrec = max(cumulative_unrecovered, na.rm = TRUE),
      total_unrec_prop = total_unrec / total_pop,
      unrec_rate_100k = round(total_unrec_prop * 1e5, 1),
      .groups = "drop"
    )
}

```



This function automatically summarizes infection data by one or more grouping variables (for example, county, sex, or race/ethnicity) and computes total population counts, cumulative infection counts, and corresponding crude rates per 100,000 population. It ensures consistent calculations across datasets and minimizes the need to repeat long dplyr pipes for each demographic of interest.


```{r}
#| code-fold: show


#- by Health Officer Region
by_HOR <-
  calc_total_rates_pop(df, pop_col = total_HOR_pop, health_officer_region)

#- by County
by_cnty <-
  calc_total_rates_pop(df, pop_col = total_cnty_pop, health_officer_region, county) 

#- by Age Category
by_age <- 
  calc_total_rates_pop(df, pop_col = pop, age_cat) 

#- by Sex
by_sex <-
  calc_total_rates_pop(df, pop_col = total_sex_pop, sex) 

#- by Race and Ethnicity
by_race <-
  calc_total_rates_pop(df, pop_col = total_race_pop, race_long)


```


**Exports:**
```{r}

# Final Exports to "data/inf_rate_dfs" project directory:

#-write.csv(by_HOR, file = here("data/inf_rate_dfs/inf_rates_by_HOR.csv"), row.names = FALSE)
#-write.csv(by_cnty, file = here("data/inf_rate_dfs/inf_rates_by_cnty.csv"), row.names = FALSE)
#-write.csv(by_age, file = here("data/inf_rate_dfs/inf_rates_by_age.csv"), row.names = FALSE)
#-write.csv(by_sex, file = here("data/inf_rate_dfs/inf_rates_by_sex.csv"), row.names = FALSE)
#-write.csv(by_race, file = here("data/inf_rate_dfs/inf_rates_by_race.csv"), row.names = FALSE)

```



```{r, echo = FALSE}

HOR_filt <- make_rate_table(
  by_HOR,
  health_officer_region,
  pop_col = total_pop,
  sort_by = "sev_rate_100k",
  top_n = NULL,                 
  drop_cols = "unrec_rate_100k",
  highlight_col = "sev_rate_100k"
)

cnty_filt <- make_rate_table(
  by_cnty,
  county,
  pop_col = total_pop,
  sort_by = "sev_rate_100k",
  top_n = 10,
  drop_cols = "unrec_rate_100k",
  highlight_col = "sev_rate_100k"
)


age_filt <- make_rate_table(
  by_age,
  age_cat,
  pop_col = total_pop,
  sort_by = "sev_rate_100k",
  top_n = NULL,                 
  drop_cols = "unrec_rate_100k",
  highlight_col = "sev_rate_100k"
)


sex_filt <- make_rate_table(
  by_sex,
  sex,
  pop_col = total_pop,
  sort_by = "sev_rate_100k",
  top_n = NULL,                 
  drop_cols = "unrec_rate_100k",
  highlight_col = "sev_rate_100k"
)


race_filt <- make_rate_table(
  by_race,
  race_long,
  pop_col = total_pop,
  sort_by = "sev_rate_100k",
  top_n = NULL,                 
  drop_cols = "unrec_rate_100k",
  highlight_col = "sev_rate_100k"
)

```


## Severe Infection Rates by Demographic


::: {.panel-tabset}


## Health Officer Region

```{r, echo = FALSE}
HOR_filt
```



## County

**Top 10 Highest Severe Infection Rates by County**
```{r, echo = FALSE}
cnty_filt
```

## Age Category

```{r, echo = FALSE}
age_filt
```


## Sex

*initial note: males have higher infection rate; but females have higher rates of severe infections and unrecovered*

```{r, echo = FALSE}
sex_filt
```



## Race/Ethnicity

*initial note: Hispanic population has highest infection rate, severe infection rate, and unrecovered rate -- all across the board -- this community is being impacted the most.*

```{r, echo = FALSE}
race_filt
```



:::


**Code for table subsets:**


```{r, eval = FALSE}

HOR_filt <- make_rate_table(
  by_HOR,
  health_officer_region,
  pop_col = total_pop,
  sort_by = "sev_rate_100k",
  top_n = NULL,                 
  drop_cols = "unrec_rate_100k",
  highlight_col = "sev_rate_100k"
)

cnty_filt <- make_rate_table(
  by_cnty,
  county,
  pop_col = total_pop,
  sort_by = "sev_rate_100k",
  top_n = 10,
  drop_cols = "unrec_rate_100k",
  highlight_col = "sev_rate_100k"
)


age_filt <- make_rate_table(
  by_age,
  age_cat,
  pop_col = total_pop,
  sort_by = "sev_rate_100k",
  top_n = NULL,                 
  drop_cols = "unrec_rate_100k",
  highlight_col = "sev_rate_100k"
)


sex_filt <- make_rate_table(
  by_sex,
  sex,
  pop_col = total_pop,
  sort_by = "sev_rate_100k",
  top_n = NULL,                 
  drop_cols = "unrec_rate_100k",
  highlight_col = "sev_rate_100k"
)


race_filt <- make_rate_table(
  by_race,
  race_long,
  pop_col = total_pop,
  sort_by = "sev_rate_100k",
  top_n = NULL,                 
  drop_cols = "unrec_rate_100k",
  highlight_col = "sev_rate_100k"
)

```
