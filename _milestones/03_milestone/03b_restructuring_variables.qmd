

## Restructuring Variables 


```{r, include = FALSE}
#| label: setup
#| include: false
#| warning: false
#| message: false

# Load and install packages
pacman::p_load(
  dplyr, tidyr, ggplot2, lubridate, ggthemes, cowplot, readr, rlang, purrr, rlang,
  classInt, tidycensus, sf, here, stringr, purrr, svglite, rmapshaper, readxl,
  scales, ggrepel, viridis, RColorBrewer, maps, ggfx, glue, skimr, DataExplorer,
  knitr, kableExtra, janitor, reactable, MMWRweek
)

# Source all helper functions
func_dir <- here::here("_functions")
r_files <- list.files(func_dir, pattern = "\\.R$", full.names = TRUE)
purrr::walk(r_files, source)


# === Load all CSVs from _data/tbl_outputs_03 ===
data_dir <- here::here("_data", "tbl_outputs_03")

csv_files <- list.files(
  path = data_dir,
  pattern = "\\.csv$",
  full.names = TRUE
)

# Read and assign each CSV to an object named after its file
purrr::walk(csv_files, function(file_path) {
  # Extract clean base name (no extension)
  obj_name <- tools::file_path_sans_ext(basename(file_path))
  # Read file
  df <- readr::read_csv(file_path, show_col_types = FALSE)
  # Assign to the global environment so all chapters can access
  assign(obj_name, df, envir = knitr::knit_global())
})

```


### Age Groups

:::: {.columns style="display: flex; gap: 2rem; justify-content: space-between;"}
::: {.column width="40%"}

The population database contains counts for six age groups, whereas the California and LA County databases use four. Because the groupings align --- “0–4,” “5–11,” and “12–17” in the population database correspond to the “0–17” group in the others --- we summarized the population counts to match the four age-group format. 

In the original population database, counts are reported for each single year of age within every demographic subgroup (e.g., county, sex, race/ethnicity). To obtain total estimates per age group and demographic category, the single-year counts were aggregated (summed). **Table 1** below presents a subset of the original and restructured population data to illustrate the resulting summarized age groupings. 


:::
::: {.column width="55%"}


```{r, eval = FALSE}

step1_ca_df <- read.csv(file = here("_data/tbl_outputs_03/step1_ca_df.csv"))
step1_la_cnty_df <- read.csv(file = here("_data/tbl_outputs_03/step1_la_cnty_df.csv"))
step1_pop_df <- read.csv(file = here("_data/tbl_outputs_03/step1_pop_df.csv"))

```


```{r}

step2_pop_df <- step1_pop_df %>%
  group_by(county, health_officer_region, 
           sex, race_ethnicity, age_cat) %>%
  summarise(pop = sum(pop), .groups = "drop")

step2_pop_df_recat <- step1_pop_df %>%
  mutate(new_age_group = 
          if_else(age_cat %in% 
              c("0-4", "5-11", "12-17"),
              "0-17", age_cat)) %>%
  group_by(county, health_officer_region, sex, 
           race_ethnicity, new_age_group) %>%
  summarise(pop = sum(pop), .groups = "drop") %>%
  rename("age_cat" = "new_age_group")
  
```


:::
::::



```{r, echo = FALSE}

pop_df_subset <- step2_pop_df %>%
  select(-health_officer_region) %>%
  filter(
    county == "Alameda",
    age_cat %in% c("0-4", "5-11", "12-17"),
    race_ethnicity == "Hispanic",
    sex == "FEMALE"
  ) %>% janitor::adorn_totals() %>%
  mutate(
    across(where(is.numeric), 
        ~ ifelse(county == "Total", 
                 comma(., accuracy = 1), .))
    )


pop_recat_subset <- step2_pop_df_recat %>%
  select(-health_officer_region) %>%
  filter(
    county == "Alameda",
    age_cat == "0-17",
    race_ethnicity == "Hispanic",
    sex == "FEMALE"
  ) %>%
  mutate(pop = comma(pop, accuracy = 1))


```


<div class="column-box">

### Table 1: Reconciling Age Group Categories and Population Counts

**Original Age Groups:**
```{r, echo = FALSE}
pop_df_subset %>% 
  kbl(align = "c",
      col.names = c("County", "Sex", "Race / Ethnicity", "Age Group", "Population")
      ) %>%
  row_spec(0, 
           bold = TRUE, 
           background = "#0f172a",
           extra_css = "font-size: 16px!important;color:#ffffff;") %>%
  row_spec(4, 
      bold = TRUE, 
      background = "#5ce1e6", 
      extra_css = "font-size: 16px!important;"
  ) %>%
  kable_styling(bootstrap_options = c("striped", "condensed", "bordered"))
```


|


**New, Aggregate Age Group:**
```{r, echo = FALSE}
pop_recat_subset %>% 
  kbl(align = "c",
      col.names = c("County", "Sex", "Race / Ethnicity", "Age Group", "Population"),
      table.attr = 'class="table table-bordered no-stripe"'
      ) %>%
  kable_styling(bootstrap_options = c("bordered")) %>%
  row_spec(0, 
           bold = TRUE, 
           background = "#0f172a",
           extra_css = "font-size: 16px!important;color:#ffffff;") %>%
  row_spec(1, background = "#ffffff") %>%
  column_spec(5, 
      bold = TRUE, 
      background = "#5ce1e6", 
      extra_css = "font-size: 16px!important;"
  )
  
```


</div>


\newpage




### Infection Dates

:::: {.columns style="display: flex; gap: 2rem; justify-content: space-between;"}
::: {.column width="40%"}

To support date-based analyses, infection records will be aggregated by **MMWR week and year**. For both the Los Angeles County and California datasets, we will generate two new columns: **mmwr_year** and **mmwr_week**, then remove the original date-based fields. We will also add columns **start_date** and **end_date** to serve as reference points should we need them later. 

In the California dataset, the field **time_int** encodes the year and MMWR week as a six-digit integer (YYYYWW). To create the new fields, we extract the first four digits as mmwr_year and the last two digits as mmwr_week, then drop the original time_int column.

In the Los Angeles County dataset, the codebook identifies a field **dt_report** as the last day of the MMWR week. However, this field contained only missing values, so it was removed. Instead, we convert the infection date field, **dt_dx** to a proper date format, and then use the `MMWRweek` package to derive the mmwr_year and mmwr_week.



:::
::: {.column width="50%"}

```{r}

##-- California dataset:
step2_ca_df <- step1_ca_df %>%
##--pull MMWR week and year from time_int field
mutate(
  mmwr_year = factor(time_int %/% 100), 
  mmwr_week = factor(time_int %% 100)) %>%
add_start_end_dates() %>%
select(-time_int) %>%
relocate(mmwr_year, mmwr_week, start_date, 
         end_date, .before = everything())


##-- LA county dataset:
step2_la_cnty_df <- step1_la_cnty_df %>%
##--restructure to proper date format
mutate(DATE_FIX = 
  as.Date(parse_date_time(dt_dx, "%d%b%Y"), 
          format = "%Y-%m-%d")) %>% 
##--use date to create new MMWR fields
add_mmwr_week_columns(date_col = "DATE_FIX") %>%
add_start_end_dates() %>%
select(-c(DATE_FIX, dt_dx)) %>%
relocate(mmwr_year, mmwr_week, start_date, 
         end_date, .before = everything()) %>%
relocate(county, .before = age_cat)


```


:::
::::


To streamline this process, we created two helper functions:

* `add_mmwr_week_columns()` : takes date column and adds two fields: mmwr_year and mmwr_week
* `add_start_end_dates()` : uses those values to generate corresponding MMWR week start and end dates


<div class="column-box">
**The dataframes now have a structure that looks like this:** 

```{r, echo = FALSE}

la_cnty_slice <- step2_la_cnty_df %>%
  select(mmwr_year, mmwr_week, start_date, end_date, county, age_cat, new_infections) %>%
  slice_head(n=3)

la_cnty_slice %>%
  rename_with(~cell_spec(
    .x,
    "html",
    bold = TRUE,
    color = "#0f172a",
    background = "#ffde59",
    font_size = 16
  ), 1:4) %>%
  kbl(escape = FALSE, align = "c") %>%
  row_spec(0, 
       bold = TRUE, 
       background = "#0f172a",
       extra_css = "font-size: 16px!important;color:#ffffff;") %>%
  kable_styling(bootstrap_options = c("bordered"))
  
```

</div>


\newpage


## Race and Ethnicity: 

Each of the three datasets defines Race / Ethnicity differently. The California dataset uses numeric codes, the Los Angeles County dataset uses full text labels, and the population dataset uses abbreviated text. 

To resolve this, we created a crosswalk file (**race_ethnicity_map.csv**) that aligns the three formats. By joining this crosswalk to each dataset, we ensure that all three contain a consistent set of race and ethnicity variables: each with the numeric code, the abbreviated text, and the full text label.


```{r, echo = FALSE}
race_ethnicity_map <- read.csv(file = here("_data/race_ethnicity_map.csv")) %>%
  mutate(
    race_long = clean(race_long),
    race_short = clean(race_short),
    race_coded = as.character(race_coded)
  )

```


```{r}

step2_ca_df <- step2_ca_df %>%
  rename("race_coded" = "race_ethnicity") %>%
  mutate(race_coded = as.character(race_coded)) %>%
  left_join(race_ethnicity_map, by = "race_coded")%>%
  relocate(race_coded, race_short, race_long, .after = sex)

step2_la_cnty_df <- step2_la_cnty_df %>%
  mutate(race_long = clean(race_ethnicity)) %>%
  select(-race_ethnicity) %>%
  left_join(race_ethnicity_map, by = "race_long") %>%
  relocate(race_coded, race_short, race_long, .after = sex)


```



### Race and Ethnicity Crosswalk Table:

```{r, echo = FALSE}

race_ethnicity_map %>% 
  kbl(align = "c") %>%
  kable_styling(bootstrap_options = c("bordered")) %>%
  row_spec(0, 
           bold = TRUE, 
           background = "#0f172a",
           extra_css = 
           "font-size: 14px!important;color:#ffffff;") 
```




\newpage


## Population Counts by Demographic

To calculate infection rates by demographic groups (such as county, health officer region, sex, or race/ethnicity), we first summarize total population counts for each demographic category within the population dataframe. The population dataset is then joined to both the master database (which merges all three datasets) and the individual California and Los Angeles datasets.

By creating and maintaining these summarized population counts, we avoid having to recalculate them each time we focus on a different demographic group. For example, once this population dataset is joined to the California data, we can easily calculate population-adjusted infection rates that allow valid comparisons across counties with differing population sizes. 

```{r}

step2_pop_df <- step2_pop_df_recat %>%
  
##-- join population database to the race/ethnicity map
  mutate(race_short = clean(race_ethnicity)) %>%
  select(-race_ethnicity) %>%
  left_join(race_ethnicity_map, by = "race_short") %>%
  relocate(race_coded, race_short, race_long, .after = sex) %>%
  
##-- calculate population totals by demographic
  group_by(county, health_officer_region) %>%
    mutate(total_cnty_pop = sum(pop)) %>% ungroup() %>%
  group_by(county, health_officer_region, race_coded, race_short, race_long) %>%
    mutate(total_race_pop = sum(pop)) %>% ungroup() %>%
  group_by(county, health_officer_region, sex) %>%
    mutate(total_sex_pop = sum(pop)) %>% ungroup() %>%
  group_by(health_officer_region) %>%
    mutate(total_HOR_pop = sum(pop)) %>% ungroup()
```



<div class="column-box">

### Table 2: Calculating Infection Rate by 100,000 Population Example

```{r, echo = FALSE}

step2_ca_df <- step2_ca_df %>%
  left_join(step2_pop_df, by = c("county" ,"sex", "race_coded", 
            "race_short", "race_long", "age_cat")) %>%
  relocate(health_officer_region,  .after = county) %>%
  relocate(pop, .after = race_long) %>%
  mutate(age_cat = factor(age_cat, levels = c("0-17", "18-49", "50-64", "65+")))

step2_la_cnty_df <- step2_la_cnty_df %>%
  left_join(step2_pop_df, by = c("county", "sex", "race_coded", 
            "race_short", "race_long", "age_cat")) %>%
  relocate(health_officer_region,  .after = county) %>%
  relocate(pop, .after = race_long) %>%
  mutate(age_cat = factor(age_cat, levels = c("0-17", "18-49", "50-64", "65+")))

by_cnty_year <- step2_ca_df %>%
  group_by(health_officer_region, county) %>%
  summarise(
    total_cnty_pop = first(total_cnty_pop),
    total_infected = max(cumulative_infected),
    total_inf_prop = total_infected / total_cnty_pop,
    inf_rate_100k = round((total_inf_prop * 10^4),1),
    .groups = "drop"
  )

```


```{r, echo = FALSE}

cnty_slice <- by_cnty_year %>%
  select(-health_officer_region) %>%
  group_by(county) %>%
  slice(1) %>%
  ungroup() %>%
  slice_head(n=3)

cnty_slice %>%
  kbl(escape = FALSE, align = "c",
    col.names = c("County", "Total Population", 
                  "Total Infected", "Proportion Infected", 
                  "Infection Rate per 100K")) %>%
  row_spec(0, 
       bold = TRUE, 
       background = "#0f172a",
       extra_css = "font-size: 16px!important;color:#ffffff;") %>%
  
  column_spec(5, 
       bold = TRUE, 
       background = "#5ce1e6"
       ) %>%  
  
  kable_styling(bootstrap_options = c("bordered"))

```

</div>




